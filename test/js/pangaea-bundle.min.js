// pangaea 2d tile renderer areologist.com/pangaea

var pan=pan||{};(function(){'use strict';pan.settings={'debugInit':true,'enablePlayer':false,'drawFps':false,'fontColor':'cyan','fontStyle':'12px "Courier New", Courier, monospace','enableHitTesting':false,'drawHitRegions':false,'drawLights':true,'logKeyInput':false,'autoResize':true,toString:function(){return'[debugInit:'+this.debugInit+',enablePlayer:'+this.enablePlayer+',drawFps:'+this.drawFps+',fontColor:'+this.fontColor+',fontStyle:'+this.fontStyle+',enableHitTesting:'+this.enableHitTesting+',drawHitRegions:'+this.drawHitRegions+',drawLights:'+this.drawLights+',logKeyInput:'+this.logKeyInput+',autoResize:'+this.autoResize+']';}};}());(function(){'use strict';var settings=pan.settings,canvas=pan.canvas,lastTime=0,vendors=['ms','moz','webkit','o'],x,len,currTime,timeToCall,id,onFullscreenChange;for(x=0,len=vendors.length;x<len&&!window.requestAnimationFrame;++x){window.requestAnimationFrame=window[vendors[x]+'RequestAnimationFrame'];window.cancelAnimationFrame=window[vendors[x]+'CancelAnimationFrame']||window[vendors[x]+'CancelRequestAnimationFrame'];}
if(!window.requestAnimationFrame){window.requestAnimationFrame=function(callback){currTime=new Date().getTime();timeToCall=Math.max(0,16-(currTime-lastTime));id=window.setTimeout(function(){callback(currTime+timeToCall);},timeToCall);lastTime=currTime+timeToCall;return id;};}
if(!window.cancelAnimationFrame){window.cancelAnimationFrame=function(id){clearTimeout(id);};}
if(settings.autoResize){onFullscreenChange=function(){var c=document.getElementById('canvas'),canvas=pan.canvas;if(document.fullscreen||document.mozFullScreen||document.webkitIsFullScreen){settings.tempSize={w:canvas.width,h:canvas.height};canvas.width=screen.width;canvas.height=screen.height;}else{if(settings.tempSize){canvas.width=settings.tempSize.w;canvas.height=settings.tempSize.h;}}
c.width=canvas.width;c.height=canvas.height;};document.addEventListener('fullscreenchange',onFullscreenChange);document.addEventListener('mozfullscreenchange',onFullscreenChange);document.addEventListener('webkitfullscreenchange',onFullscreenChange);}}());(function(){'use strict';pan.Layer=function(data,name,type,left,top,width,height,objects){var map=pan.canvas.map;this.data=data||[];this.name=name;this.type=type;this.left=left||0;this.top=top||0;this.width=width||map.width;this.height=height||map.height;this.coords=[];this.objects=objects||[];};pan.Layer.prototype.update=function(){};pan.Layer.prototype.render=function(){};pan.Layer.prototype.prerender=function(){var canvas=pan.canvas,map=canvas.map,tilesets=canvas.tilesets,atlases=canvas.atlases,table=canvas.table,i,x,y,len,tileIndex,tileset,atlas,atlasindex,frame,length;if(this.type==='tilelayer'){for(i=0,len=this.data.length;i<len;i++){tileIndex=this.data[i];if(tileIndex===0){continue;}
for(x=tilesets.length;x>=0;x){x--;if(tilesets[x].firstgid<=tileIndex){tileset=tilesets[x];x=-1;}}
for(y=0;y<atlases.length;y++){atlas=atlases[y];atlasindex=y;frame=this.selectFrame(atlas,tileset.image);if(frame){break;}}
this.computeFrame(map,frame,i,tileset,tileIndex);if(!pan.canvas.table){length=Math.ceil((this.width/map.tilewidth)*(this.height/map.tileheight));table=pan.canvas.table=[length];}
table[tileIndex]={aindex:0,srcx:frame.srcx,srcy:frame.srcy,w:tileset.tilewidth,h:tileset.tileheight};}}else{if(this.name==='lights'){this.type='lights';for(i=0;i<this.objects.length;i++){frame=this.objects[i];if(frame.ellipse&&frame.visible){canvas.lights.push({x:frame.x,y:frame.y,w:frame.width,h:frame.height});}}}else if(this.name==='hittest'){this.type='hittest';for(i=0;i<this.objects.length;i++){frame=this.objects[i];if(frame.visible){canvas.hitRegions.push({x:frame.x,y:frame.y,w:frame.width,h:frame.height});}}}}};pan.Layer.prototype.computeFrame=function(map,frame,index,tileset,tileIndex){var xpos,ypos,localindex,localwidth;frame.srcx=0;frame.srcy=0;localindex=tileIndex-tileset.firstgid;localwidth=frame.frame.w/map.tilewidth;frame.srcx=Math.round(((localindex/localwidth)%1)*localwidth)*map.tilewidth;frame.srcx=frame.srcx+frame.frame.x;frame.srcy=Math.floor(localindex/localwidth)*map.tileheight;frame.srcy=frame.srcy+frame.frame.y;xpos=Math.round(((index/map.width)%1)*map.width*map.tilewidth);ypos=Math.floor(index/map.width)*map.tileheight;this.coords[index]={xpos:xpos,ypos:ypos};};pan.Layer.prototype.selectFrame=function(atlas,key){var z,len,frames=atlas.frames;for(z=0,len=frames.length;z<len;z++){if(frames[z].filename===key){return frames[z];}}
return null;};}());(function(){'use strict';pan.loadAtlas=function(json){var name,imagePath,image,atlas;if(!json){throw{name:'paramError',message:'Required parameter not supplied.'};}
name=json.meta.image;imagePath='assets/'+name;image=new Image();image.src=imagePath;atlas=new pan.Atlas(image,name,json.meta.size,json.frames);return atlas;};pan.loadAtlasAsync=function(json,onloadCallback){if(!json||!onloadCallback){throw{name:'paramError',message:'Required parameter not supplied.'};}
var image,name=json.meta.image,imagePath='assets/'+name,size=json.meta.size,frames=json.frames;image=new Image();image.onload=function(){var atlas=new pan.Atlas(image,name,size,frames);if(onloadCallback){onloadCallback(atlas);}};image.src=imagePath;};pan.Atlas=function(image,name,size,frames){this.image=image;this.name=name;this.size=size;this.frames=frames;};pan.Atlas.prototype.update=function(){};pan.Atlas.prototype.draw=function(){};}());(function(){'use strict';pan.loadSpriteSheet=function(key,filePath){var image,spritesheet;if(!filePath){throw{name:'paramError',message:'Required parameter not supplied.'};}
image=new Image();image.src=filePath;spritesheet=new pan.SpriteSheet(image,key);return spritesheet;};pan.loadSpriteSheetAsync=function(key,filePath,onloadCallback){if(!filePath||!onloadCallback){throw{name:'paramError',message:'Required parameter not supplied.'};}
var name=key||filePath,image=new Image();image.onload=function(){var spritesheet=new pan.SpriteSheet(image,name);if(onloadCallback){onloadCallback(spritesheet);}};image.src=filePath;};pan.SpriteSheet=function(image,key){this.image=image;this.name=key;};}());(function(){'use strict';pan.canvas={width:800,height:544,backcolor:'#000',context:null,atlases:[],spritesheets:[],layers:[],tilesets:[],lights:[],hitRegions:[],map:{tileheight:0,tilewidth:0,width:0,height:0,offsetx:0,offsety:0,clamp:{x:0,y:0,w:0,h:0}},frameId:null,onupdate:null,onrender:null,ready:false,loadMap:function(json){var i,len,canvas=pan.canvas,map=canvas.map,clamp=map.clamp,layers=canvas.layers;if(!json){throw{name:'paramError',message:'Required parameter not supplied.'};}
map.tilewidth=json.tilewidth;map.tileheight=json.tileheight;map.width=json.width;map.height=json.height;clamp.x=canvas.width/2;clamp.y=canvas.height/2;clamp.w=(map.width*map.tilewidth)-map.clamp.x;clamp.h=(map.height*map.tileheight)-map.clamp.y;for(i=0,len=json.layers.length;i<len;i++){layers.push(new pan.Layer(json.layers[i].data,json.layers[i].name,json.layers[i].type,json.layers[i].x,json.layers[i].y,json.layers[i].width,json.layers[i].height,json.layers[i].objects));}
canvas.tilesets=json.tilesets;},attach:function(element,updateCallback,renderCallback){var canvasElement=document.createElement('canvas'),canvas=pan.canvas;canvasElement.setAttribute('id','canvas');canvasElement.setAttribute('width',canvas.width);canvasElement.setAttribute('height',canvas.height);canvas.context=canvasElement.getContext('2d');if(!element.appendChild){element=document.getElementById(element);}
element.appendChild(canvasElement);if(updateCallback){canvas.onupdate=updateCallback;}
if(renderCallback){canvas.onrender=renderCallback;}},start:function(){var canvas=pan.canvas;canvas.prerender();if(pan.util){pan.util.start(canvas);}
if(!canvas.frameId){canvas.frame();}},stop:function(){pan.canvas.ready=false;},reset:function(){var canvas=pan.canvas;canvas.stop();canvas.layers=[];canvas.atlases=[];canvas.tilesets=[];canvas.spritesheets=[];canvas.table=null;canvas.lights=[];canvas.hitRegions=[];canvas.map={tileheight:0,tilewidth:0,width:0,height:0,offsetx:0,offsety:0,clamp:{x:0,y:0,w:0,h:0}};if(pan.util){pan.util.reset(canvas);}},frame:function(){var canvas=pan.canvas;if(canvas.ready){canvas.update();canvas.render();}
canvas.frameId=window.requestAnimationFrame(canvas.frame);},update:function(){var i,len,canvas=pan.canvas,layers=canvas.layers;for(i=0,len=layers.length;i<len;i++){layers[i].update();}
if(canvas.onupdate){canvas.onupdate(canvas);}
if(pan.util){pan.util.update(canvas);}},prerender:function(){var i,len,layers=pan.canvas.layers;for(i=0,len=layers.length;i<len;i++){layers[i].prerender();}
pan.canvas.ready=true;},render:function(){var x,i,len,dlen,layer,tileIndex,record,coords,xpos,ypos,canvas=pan.canvas,layers=canvas.layers,table=canvas.table,width=pan.canvas.width,height=pan.canvas.height,offsetx=pan.canvas.map.offsetx,offsety=pan.canvas.map.offsety;canvas.clear();for(x=0,len=layers.length;x<len;x++){layer=layers[x]||{};if(layer.type!=='tilelayer'){continue;}
for(i=0,dlen=layer.data.length;i<dlen;i++){tileIndex=layer.data[i];coords=layer.coords[i];if(tileIndex===0||!coords){continue;}
record=table[tileIndex];xpos=coords.xpos+offsetx;ypos=coords.ypos+offsety;if(xpos+record.w>offsetx&&xpos<width&&ypos+record.h>offsety&&ypos<height){canvas.context.drawImage(canvas.atlases[record.aindex].image,record.srcx,record.srcy,record.w,record.h,xpos,ypos,record.w,record.h);}}}
if(canvas.onrender){canvas.onrender();}
if(pan.util){pan.util.render(canvas);}},clear:function(){var canvas=pan.canvas,context=pan.canvas.context;context.fillStyle=canvas.backcolor;context.fillRect(0,0,canvas.width,canvas.height);}};pan.canvas.print=function(text,x,y,font,color){var context=pan.canvas.context;x=x||12;y=y||16;context.font=font||'10pt "Courier New", Courier, monospace';context.fillStyle=color||'cyan';context.fillText(text,x,y);};pan.canvas.drawHitRegions=function(borderColor,fillColor){var i,len,r,bc=borderColor||'red',fc=fillColor||'rgba(255, 0, 0, 0.1)',canvas=pan.canvas,context=canvas.context,regions=canvas.hitRegions,map=canvas.map;context.beginPath();for(i=0,len=regions.length;i<len;i++){r=regions[i];context.rect(r.x+map.offsetx,r.y+map.offsety,r.w,r.h);}
context.fillStyle=fc;context.fill();context.strokeStyle=bc;context.stroke();context.closePath();};}());(function(){'use strict';pan.util=pan.util||{};pan.util.start=function(canvas){canvas.last=Date.now();if(pan.settings.drawFps||pan.settings.debugInit){canvas.deltaTimer=new pan.util.DeltaTimer();canvas.deltaTimer.start(60);}
if(pan.settings.enablePlayer||pan.settings.debugInit){canvas.player=new pan.util.Player(canvas.width/2-16,canvas.height/2-16);}
pan.util.keyboard.bind();};pan.util.reset=function(canvas){canvas.last=Date.now();if(pan.settings.drawFps||pan.settings.debugInit){canvas.deltaTimer.start(60);}
if(pan.settings.enablePlayer||pan.settings.debugInit){canvas.player=new pan.util.Player(canvas.width/2-16,canvas.height/2-16);}};pan.util.update=function(canvas){if(pan.settings.enablePlayer){canvas.player.update();}
if(pan.settings.drawFps){canvas.deltaTimer.ready();}};pan.util.render=function(canvas){var settings=pan.settings,context=canvas.context;if(settings.drawHitRegions){if(canvas.drawHitRegions){canvas.drawHitRegions();}}
if(settings.enablePlayer){canvas.player.draw(canvas.context);}
if(settings.drawFps){context.font=settings.fontStyle;context.fillStyle=settings.fontColor;context.fillText('FPS: '+
canvas.deltaTimer.getFrameRate(),6,14);}};pan.util.DeltaTimer=function(){var startTime,frames=0,frameRate=0,last=0,target=0,overflow=0,resetThreshold=100,resetCount=0;return{start:function(fps){last=new Date().getTime();target=1000/fps;startTime=new Date().getTime();},ready:function(){var diff=(new Date().getTime()-last)+overflow;if(diff>=target){overflow=diff-target;if(overflow>resetThreshold){overflow=0;frames=0;startTime=new Date().getTime();resetCount+=1;if(resetCount>25){resetThreshold+=20;resetCount=0;}}
last=new Date().getTime();frames++;if((frames%10)===0){frameRate=frames/((new Date().getTime()-startTime)/1000);}
return true;}
return false;},getFrameRate:function(){return Math.round(frameRate*1000,10)/1000;}};};pan.util.Player=function(x,y,w,h){var c,bc,cx,cy;x=x||0;y=y||0;w=w||32;h=h||32;cx=x;cy=y;c='rgba(0, 98, 174, 0.75)';bc='rgba(255, 64, 64, 1)';return{color:c,bordercolor:bc,speed:2,update:function(){var key,rate,bounds,i,len,region,buffer={x:cx,y:cy},canvas=pan.canvas,map=canvas.map,hitRegions=canvas.hitRegions,keyboard=pan.util.keyboard;if(keyboard.stack.length>0){rate=keyboard.shift?this.speed*2:this.speed;key=keyboard.peek();if(key==='w'){cy-=rate;}else if(key==='a'){cx-=rate;}else if(key==='s'){cy+=rate;}else if(key==='d'){cx+=rate;}
if(cx===buffer.x&&cy===buffer.y){return;}
cx=cx.clamp(0,(map.width*32)-w);cy=cy.clamp(0,(map.height*32)-h);if(pan.settings.enableHitTesting){for(i=0,len=hitRegions.length;i<len;i++){region=hitRegions[i];if(this.hitTest(region,cx,cy,cx+w,cy+h)){cx=buffer.x;cy=buffer.y;return false;}}}
bounds=map.clamp;if(cx>=bounds.x&&cx<=bounds.w){map.offsetx=-(cx-bounds.x);x=bounds.x;}else{x=(cx>=bounds.x)?cx-(bounds.w-bounds.x):cx;x=x.clamp(0,canvas.width-w);}
if(cy>=bounds.y&&cy<=bounds.h){map.offsety=-(cy-bounds.y);y=bounds.y;}else{y=(cy>=bounds.y)?cy-(bounds.h-bounds.y):cy;y=y.clamp(0,canvas.height-h);}}},draw:function(context){context.beginPath();context.rect(x,y,w,h);context.strokeStyle=this.bordercolor;context.stroke();context.fillStyle=this.color;context.fill();context.closePath();},hitTest:function(region,left,top,right,bottom){return(region.x<right)&&((region.x+region.w)>left)&&(region.y<bottom)&&((region.y+region.h)>top);}};};pan.util.keyboard={stack:[],shift:false,peek:function(){var temp=this.stack.pop();this.stack.push(temp);return temp;},keydown:function(code){if(this.stack.length>0){if(this.peek()!==code){this.stack.push(code);}}else{this.stack.push(code);}},keyup:function(code){this.stack=this.stack.filter(function(item){return item!==code;});},clear:function(){this.stack=[];this.shift=false;},bind:function(){var keyboard=pan.util.keyboard;document.onkeydown=function(event){event=event||window.event;var code=event.keyCode;if(code===16){keyboard.shift=true;}else if(code===87){keyboard.keydown('w');}else if(code===65){keyboard.keydown('a');}else if(code===83){keyboard.keydown('s');}else if(code===68){keyboard.keydown('d');}
if(pan.settings.logKeyInput){console.log('keybown.keycode: '+code+'; keyboard: '+
keyboard.toString());}};document.onkeyup=function(event){event=event||window.event;var code=event.keyCode;if(code===16){keyboard.shift=false;}else if(code===87){keyboard.keyup('w');}else if(code===65){keyboard.keyup('a');}else if(code===83){keyboard.keyup('s');}else if(code===68){keyboard.keyup('d');}
if(pan.settings.logKeyInput){console.log('keyup.keycode: '+code+'; keyboard: '+
keyboard.toString());}};window.onblur=function(){keyboard.clear();};},toString:function(){return'[stack.length:'+this.stack.length+',shift:'+this.shift+']';}};Number.prototype.clamp=function(min,max){return Math.min(Math.max(this,min),max);};}());